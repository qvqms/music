<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="无名音乐官网" name="keywords"/>
    <meta content="免费下载无损音乐" name="description"/>
    <meta content="微信公众号:从来不想" name="description">
    <title>无名音乐-在线版</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/wind.css" rel="stylesheet">
    <link href="favicon.ico" rel="icon" type="image/x-icon">
    <script src="js/jquery-3.5.1.js"></script>
    <script src="js/jquery.cookie.js"></script>
    <script src="js/jquery.base64.js"></script>
    <script src="js/winpan.js"></script>
    <script src="js/adopt.js"></script>
    <script src="js/download.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/common.js"></script>
</head>
<body style="background-color: #F0F0F0">

<div class="navbar fixed-top thewind_nav_top m-auto justify-content-center" id="div_header" style="min-height:60px">
    <div class="wind_hand_style" id="div_brand" onclick="backToDomain()" style="font-weight: bold">TheWind</div>
    <div style="width: 2em"></div>
    <div class="input-group input-group-lg col-lg-3 col-10">
        <input class="form-control" id="search_input" type="text">
    </div>
    <span class="btn-lg btn-primary" id="span_search_music" onclick="refreshPage()">搜索</span>
    <!--    <input id="search_input" type="text" placeholder="输入音乐名" class="border-0" style="background-color: #F0F0F0">-->
    <!--    <div style="width: 1em"></div>-->
    <!--    <div id="div_search_music" class="wind_hand_style" onclick="refreshPage()">搜索</div>-->
    <div style="width: 1em"></div>
<!--    <div class="wind_hand_style" data-target="#loginModal" data-toggle="modal" id="div_user_login">登录</div>-->
    <div style="width: 1em"></div>
<!--    <div class="wind_hand_style" data-target="#regModal" data-toggle="modal" id="div_user_reg">注册</div>-->
<!--    <div class="wind_hand_style" onclick="openUrl('/ad')" data-toggle="modal" id="div_ad">商务合作</div>-->
    <div style="width: 1em"></div>
    <div class="wind_hand_style" onclick="openUrl('/about')" data-toggle="modal" id="div_about">关于</div>
    <div style="width: 1em"></div>
    <div class="wind_hand_style font-weight-bold" onclick="openUrl('/app')" data-toggle="modal" id="div_app"><span style="color: red">官方App</span></div>
    <img alt="" class="wind_hand_style" hidden id="img_user_avatar" src="/img/person.png">
    <div style="width: 1em"></div>
    <div class="wind_hand_style font-weight-bold" data-target="#wxModal" data-toggle="modal" id="div_user_wx">公众号</div>
</div>

<div aria-hidden="true" aria-labelledby="myModalLabel" class="modal fade" id="loginModal" role="dialog" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header justify-content-center m-auto">
                <h4 class="modal-title" id="myModalLabel">登录</h4>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input class="form-control" id="input_userid" placeholder="用户ID" type="text">
                    <div class="input-group-append">
                        <span class="input-group-text">用户ID</span>
                    </div>
                </div>
                <div class="input-group mb-3">
                    <input class="form-control" id="input_password" placeholder="密 码" type="password">
                    <div class="input-group-append">
                        <span class="input-group-text">密&nbsp&nbsp&nbsp&nbsp码</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal" type="button">取消</button>
                <button class="btn btn-primary" data-dismiss="modal" onclick="login()" type="button">登录</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<div aria-hidden="true" aria-labelledby="myModalLabel" class="modal fade" id="regModal" role="dialog" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header justify-content-center m-auto">
                <h4 class="modal-title" id="regModalLabel">注册</h4>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input class="form-control" id="input_reg_userid" placeholder="六位或以上字符，以字母开头" type="text">
                    <div class="input-group-append">
                        <span class="input-group-text">用户&nbsp&nbsp&nbsp&nbspID</span>
                    </div>
                </div>
                <div class="input-group mb-3">
                    <input class="form-control" id="input_reg_username" placeholder="英文汉字均可" type="text">
                    <div class="input-group-append">
                        <span class="input-group-text">昵&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp称</span>
                    </div>
                </div>
                <div class="input-group mb-3">
                    <input class="form-control" id="input_reg_password" placeholder="6位或以上的字符，以字母开头" type="password">
                    <div class="input-group-append">
                        <span class="input-group-text">密&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp码</span>
                    </div>
                </div>
                <div class="input-group mb-3">
                    <input class="form-control" id="input_reg_dup_password" placeholder="6位或以上的字符，以字母开头"
                           type="password">
                    <div class="input-group-append">
                        <span class="input-group-text">再输一遍</span>
                    </div>
                </div>
                <div class="input-group mb-3">
                    <input class="form-control" id="input_reg_email" placeholder="邮 箱" type="email">
                    <div class="input-group-append">
                        <span class="input-group-text">邮&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp箱</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal" type="button">取消</button>
                <button class="btn btn-primary" data-dismiss="modal" onclick="regAccount()" type="button">注册</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<div aria-hidden="true" aria-labelledby="myModalLabel" class="modal fade" id="wxModal" role="dialog" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header justify-content-center m-auto">
                <h4 class="modal-title" id="myWx">关注微信公众号</h4>
            </div>
            <div class="modal-body">
                <p>扫码关注公众号</p>
                <img alt="" class="col-12" src="img/wechatpublic.jpg">
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" data-dismiss="modal" type="button">确定</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>

<div id="div_top_sep"></div>

<div id="div_music_search_area">
</div>

<div id="div_music_list"></div>

<div class="navbar fixed-bottom navbar-fixed-bottom justify-content-center thewind_nav_bottom " id="div_bottom_player"
     style="height: 80px;">
    <img id="img_player_icon" src="https://cdnmusic.migu.cn/picture/2022/0429/1328/AS7bf48f32d48bb44b914105795e238bdc.jpg"
         style="width: 50px;height: 50px">
    <span id="span_player_info">春风十里 -鹿先森乐队</span>
    <span style="width: 1em"></span>
    <audio controls="controls" id="audio_player"
           src="https://freetyst.nf.migu.cn/public/product5th/product27/2018/12/21/2018%E5%B9%B411%E6%9C%8822%E6%97%A517%E7%82%B912%E5%88%86%E7%B4%A7%E6%80%A5%E5%86%85%E5%AE%B9%E5%87%86%E5%85%A5%E4%B8%AD%E5%8A%B2%E8%BF%9C%E4%B8%9C9%E9%A6%96/%E6%AD%8C%E6%9B%B2%E4%B8%8B%E8%BD%BD/MP3_40_16_Stero/69906708177.mp3"></audio>
</div>

<script>

    let div_header = $('#div_header');
    let div_brand = $('#div_brand');
    let span_search_music = $('#span_search_music');
    let div_top_sep = $('#div_top_sep');
    let div_music_list = $('#div_music_list');
    let search_input = $('#search_input');
    let div_music_search_area = $('#div_music_search_area');
    let div_user_login = $('#div_user_login');
    let div_user_reg = $('#div_user_reg');
    let img_user_avatar = $('#img_user_avatar');
    let div_bottom_player = $('#div_bottom_player');
    let img_player_icon = $('#img_player_icon');
    let span_player_info = $('#span_player_info');
    let audio_player = $('#audio_player');

    let input_userid = $('#input_userid');
    let input_password = $('#input_password');

    let input_reg_password = $('#input_reg_password');
    let input_reg_userid = $('#input_reg_userid');

    let input_reg_dup_password = $('#input_reg_dup_password');
    let input_reg_email = $('#input_reg_email');
    let input_reg_username = $('#input_reg_username');

    let div_user_wx = $('#div_user_wx');


</script>

<script>

    //绑定回车事件
    search_input.on('keypress', function (e) {
        if (e.keyCode === 13) {
            refreshPage();
        }
    });

    function downloadMusic(songId, songSrc, quality) {
        let formData = new FormData();
        formData.append('songid', songId);
        formData.append('src', songSrc);
        formData.append('quality', quality);
        $.ajax({
            url: '/music/api/download',
            type: 'POST',
            cache: false,
            data: formData,
            async: true,
            processData: false,
            contentType: false,
            success: function (params) {
                parseDownloadInfo(params, quality);
            }
        });
    }

    function playerMusic(songId, songSrc, quality, songName, albumName, avatar) {
        let formData = new FormData();
        formData.append('songid', songId);
        formData.append('src', songSrc);
        formData.append('quality', quality);
        $.ajax({
            url: '/music/api/download',
            type: 'POST',
            cache: false,
            data: formData,
            async: true,
            processData: false,
            contentType: false,
            success: function (params) {
                parsePlayerInfo(params, quality, songName, albumName, avatar);
            }
        });
    }

    function parsePlayerInfo(params, quality, songName, albumName, avatar) {
        let downloadLink = params.downloadLinkMap[quality];
        if (downloadLink != null) {
            img_player_icon.attr('src', avatar);
            span_player_info.html(songName + "&nbsp;&nbsp;&nbsp;&nbsp;" + albumName);
            audio_player.attr('src', downloadLink);
        }
    }

    function playMusic(songId, songSrc, songName, albumName, avatar) {
        playerMusic(songId, songSrc, 'PQ', songName, albumName, avatar);
    }

    function hiddenDownloadBtn(currQuality, maxQuality) {
        if ((maxQuality === 'HQ' || maxQuality === 'SQ' || maxQuality === 'ZQ') && currQuality === 'EQ') {
            return 'hidden'
        }
        if ((maxQuality === 'HQ' || maxQuality === 'SQ') && currQuality === 'ZQ') {
            return 'hidden'
        }
        if (maxQuality === 'HQ' && currQuality === 'SQ') {
            return 'hidden'
        }
        return ''
    }

    function parseDownloadInfo(params, quality) {
        let downloadLink = params.downloadLinkMap[quality];
        if (downloadLink == null || (downloadLink.indexOf("flac") === -1 && downloadLink.indexOf("mp3") === -1)) {
            alert("暂无音源，或触发12小时访问限制，请关注公众号查看最新动态")
            div_user_wx.click()
            return
        }
        location.href = downloadLink;
    }

    function refreshPage() {
        let keyword = encodeURI(search_input.val());
        location.href = "?keyword=" + keyword;
    }

    function goToPlayer(shareId) {
        location.href = "player?shareId=" + shareId;
    }

    function searchMusic() {
        let keyword = parseRealKey("keyword");
        if (keyword == null) {
            return;
        }
        search_input.val(keyword);
        let src = 'KW';
        let num = '20';
        let formData = new FormData();
        formData.append('src', src);
        formData.append('keyword', keyword);
        formData.append('num', num);
        $.ajax({
            url: '/music/api/search',
            type: 'POST',
            cache: false,
            data: formData,
            async: true,
            processData: false,
            contentType: false,
            success: function (params) {
                parseSearchInfo(params);
            }
        });
    }

    function parseSearchInfo(params) {
        if (params.length === 0) {
            alert("暂无搜索结果,请关注公众号查看最新动态")
            div_user_wx.click()
            return
        }
        if (params.err_code === -1) {
            alert(params.msg + "")
            div_user_wx.click()
            return
        }
        //div_music_search_area.html('');
        for (let i = 0; i < params.length; i++) {
            let musicInfo = params[i];
            let songSrc = musicInfo.songSrc;
            let songId = musicInfo.songId;
            let songName = musicInfo.songName;
            let singersId = musicInfo.singersId;
            let singersName = musicInfo.singersName;
            let singerName = singersName[0];
            let albumId = musicInfo.albumId;
            let albumName = (musicInfo.albumName != null && musicInfo.albumName.length > 1) ? '《' + musicInfo.albumName + '》' : '';
            let picUrl = musicInfo.picUrl;
            let lrcUrl = musicInfo.lrcUrl;
            let mvUrl = musicInfo.mvUrl;
            let quality = musicInfo.quality;
            let shareId = songSrc + "_" + songId;
            let mediaMid = musicInfo.med

            if (picUrl == null || picUrl.toString().length === 0) {
                picUrl = "img/wind-icon-256.png";
            }

            let div_music_item_html = '    <div class="navbar thewind_nav_top col-11 col-lg-6 m-auto" style="min-height:' + getFileItemHeight() + 'px">\n' +
                '        <img class="file_icon_style float-left wind_hand_style" src=\"' + picUrl + '\" alt="" style="width: ' + getIconSize() + 'px;height: ' + getIconSize() + 'px" onclick="goToPlayer(\'' + shareId + '\')">\n' +
                '        <div class="wind_hand_style" onclick="playMusic(\'' + songId + '\',\'' + songSrc + '\',\'' + songName + '\',\'' + albumName + '\',\'' + picUrl + '\')">\n' +
                '        <span style="font-size: ' + getDescTextSize() + 'px;margin-right: 1em;font-weight: bold" >' + songName + '</span>\n' +
                '        <span style="font-size: ' + getDescTextSize() + 'px">' + albumName + '</span>\n' +
                '        </div>\n' +
                '        <div >\n' +
                '            <span style="font-size: ' + getDescTextSize() + 'px">' + singerName + '</span>\n' +
                '            <span style="font-size: ' + getTextSize() + 'px" class="wind_hand_style m-1 text-success font-weight-bold" onclick="downloadMusic(\'' + songId + '\',\'' + songSrc + '\',\'EQ\')" ' + hiddenDownloadBtn("EQ", quality) + '>EQ</span>\n' +
                '            <span style="font-size: ' + getTextSize() + 'px" class="wind_hand_style m-1 text-warning font-weight-bold" onclick="downloadMusic(\'' + songId + '\',\'' + songSrc + '\',\'ZQ\')" ' + hiddenDownloadBtn("ZQ", quality) + '>ZQ</span>\n' +
                '            <span style="font-size: ' + getTextSize() + 'px" class="wind_hand_style m-1 text-danger font-weight-bold" onclick="downloadMusic(\'' + songId + '\',\'' + songSrc + '\',\'SQ\')" ' + hiddenDownloadBtn("SQ", quality) + '>SQ</span>\n' +
                '            <span style="font-size: ' + getTextSize() + 'px" class="wind_hand_style m-1 text-info font-weight-bold" onclick="downloadMusic(\'' + songId + '\',\'' + songSrc + '\',\'HQ\')">HQ</span>\n' +
                '            <span style="font-size: ' + getTextSize() + 'px" class="wind_hand_style m-1 text-primary font-weight-bold" onclick="downloadMusic(\'' + songId + '\',\'' + songSrc + '\',\'PQ\')">PQ</span>\n' +
                '            <span style="font-size: ' + getTextSize() + 'px" class="wind_hand_style m-1 text-success font-weight-bold" onclick="downloadMusic(\'' + songId + '\',\'' + songSrc + '\',\'LQ\')">LQ</span>\n' +
                '        </div>\n' +
                '\n' +
                '    </div>\n' +
                '    <div style="height: 10px"></div>';
            div_music_search_area.append(div_music_item_html);
        }
    }

</script>

<script>
    function adoptSize() {
        div_header.css('min-height', getHeaderHeight());
        div_brand.css('font-size', getBrandTextSize());
        span_search_music.css('font-size', getTextSize() * 1.1);
        div_user_login.css('font-size', getTextSize() * 1.1);
        div_user_wx.css('font-size', getTextSize() * 1.1);
        div_user_reg.css('font-size', getTextSize() * 1.1);
        div_top_sep.css('height', getMarginTopHeight());
        div_music_list.css('height', getFileItemHeight());
        search_input.css('min-height', getFileItemHeight() * 0.5);
        search_input.css('min-width', 3 * getFileItemHeight());
        search_input.css('font-size', getTextSize() * 1.1);
        div_bottom_player.css('min-height', getFileItemHeight());
        span_player_info.css('font-size', getDescTextSize());
        img_user_avatar.css('width', getIconSize(), 'height', getIconSize());
    }

    adoptSize();
    searchMusic();
</script>

<script>

    function openUrl(url) {
        window.open(url, '_blank');
    }

    function login() {
        let userId = input_userid.val();
        let password = input_password.val();
        let formData = new FormData();
        formData.append('userId', userId);
        formData.append('password', password);
        $.ajax({
            url: '/api/login',
            type: 'POST',
            cache: false,
            data: formData,
            async: true,
            processData: false,
            contentType: false,
            success: function (params) {
                parseLoginInfo(params);
            }
        });
    }

    function parseLoginInfo(params) {
        let data = params.code;
        if (data === 0) {
            parseUserInfo(params.obj);
        } else {
            alert(params.msg);
        }
    }

    function parseUserInfo(user) {

        div_user_login.html(user.userName);
        div_user_reg.hide();
        img_user_avatar.removeAttr('hidden');
        img_user_avatar.attr('src', user.avatar);

    }

    function regAccount() {
        let userId = input_reg_userid.val();
        let password = input_reg_password.val();
        let dupPassword = input_reg_dup_password.val();
        let email = input_reg_email.val();
        let userName = input_reg_username.val();
        if (password !== dupPassword) {
            alert("输入密码不一致");
        } else if (!validEmail(email)) {
            alert("邮箱格式错误，邮箱是找回密码的唯一方式");
        } else if (!validUserId(userId)) {
            alert("用户ID为字母开头的字符串，且长度需要大于6");
        } else {
            regNewAccount(userId, password, email, userName, function (params) {
                if (params != null && params.code === 0) {
                    alert("注册成功");
                    parseUserInfo(params.obj);
                } else {
                    alert(params.msg);
                }
            });
        }
    }
</script>

<script>


    function restoreUserInfo() {
        let info = getCookie('info');
        if (info != null) {
            // let base64Dec=JSON.parse($.base64.decode(info));
            let base64Dec = JSON.parse($.base64.decode(info));
            if (base64Dec != null && base64Dec.userName != null) {
                parseUserInfo(base64Dec);
            }

        }
    }

    restoreUserInfo();
</script>


</body>
</html>